<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<META name="GENERATOR" content="IBM WebSphere Studio Homepage Builder Version 7.0.0.0 for Windows">
<META http-equiv="Content-Style-Type" content="text/css">
<TITLE>Alarm (overview)</TITLE>
<LINK rel="stylesheet" href="../../css/nitro.css" type="text/css">
</HEAD>
<BODY>
<H1 align="left">Alarm (overview)</H1>
<H2>説明</H2>
<P>アラームは、4つあるハードウェアタイマの1つを利用して、アプリケーションが指定した時刻に割り込みを発生させるシステムです。時刻の基準には、チックシステムのチック値を使用しますので、チックシステムが動作していなければなりません。従って、アラームシステムを使用する場合は、チックシステムがハードウェアタイマの1つを使用し、アラームが別のハードウェアタイマを1つ使用するので、ユーザに開放されるタイマは残りの2つということになります。</P>
<HR>
<P><B>初期化</B></P>
<P>アラームシステムを使用するときは、最初に一度 <CODE><A href="OS_InitAlarm.html">OS_InitAlarm()</A></CODE> を呼んでください。ただし　OS_InitAlarm() を呼び出す前にチックシステムの初期化関数
<CODE><A href="../time/OS_InitTick.html">OS_InitTick()</A></CODE> が呼ばれている必要があります。</P>
<P>アラームシステムが使用可能かどうかは <CODE><A href="OS_IsAlarmAvailable.html">OS_IsAlarmAvailable()</A></CODE> で調べることが出来ます。</P>
<P>アラームシステムに割り当てていたハードウェアタイマを開放し、アラームシステムを終了するには <CODE><A href="OS_EndAlarm.html">OS_EndAlarm()</A></CODE> を呼んでください。</P>
<HR>
<P><B>アラームの設定</B></P>
<P>アラームを設定するには OSAlarm 構造体オブジェクトを用意してください。このオブジェクト1つに対し、1つのアラームを設定することが出来ます。オブジェクトは
<CODE><A href="OS_CreateAlarm.html">OS_CreateAlarm()</A></CODE> で初期化してください。</P>
<P>アラームの設定は <CODE><A href="OS_SetAlarm.html">OS_SetAlarm()</A></CODE> 関数を用います。設定は、指定のハンドラを呼ばせたい時刻 ( 現在を基準とした相対時刻 ) を、チック値で指定します。</P>
<P>一定の周期でアラームハンドラが呼ばれるように設定にする <CODE><A href="OS_SetPeriodicAlarm.html">OS_SetPeriodicAlarm()</A></CODE> という周期アラーム設定関数も用意されています。</P>
<P>指定の時刻に、別の割り込み処理や、別のアラームハンドラなどが動作しているために割り込むことが出来なかったアラームは、割り込みが可能になったときにすぐにアラームハンドラが呼ばれます。このように割り込みが遅延されることもあります。遅延されたアラームが複数ある場合は、それらは連続して呼び出されます。</P>
<P>通常は、割り込みハンドラはすぐに終わるような処理を行なうように推奨されています。</P>
<HR>
<P><B>アラームのキャンセル</B></P>
<P>設定したアラームをキャンセルする場合は <CODE><A href="OS_CancelAlarm.html">OS_CancelAlarm()</A></CODE> を呼んでください。これは指定した 1つのアラームをキャンセルします。</P>
<P>すべてのアラームをキャンセルする場合は <CODE><A href="OS_CancelAllAlarms.html">OS_CancelAllAlarm()</A></CODE> を呼んでください。</P>
<P>タグ値を指定してキャンセルする方法もあります。(後述)</P>
<HR>
<P><B>アラームタグについて</B></P>
<P>アラームには、1〜255のタグ値を与えることができます。この値は、あるタグ値のアラームをすべてキャンセルする、という用途で使用します。</P>
<P>タグ値はすでに設定されたアラームに対し <CODE><A href="OS_SetAlarmTag.html">OS_SetAlarmTag()</A></CODE> でセットします。</P>
<P>タグ値を指定してキャンセルする関数は<CODE><A href="OS_CancelAlarms.html"> OS_CancelAlarms()</A></CODE> となります。( 複数形の「s」が付いています。)</P>
<HR>
<P><B>内部データ構造</B></P>
<P>アラーム構造体 OSAlarm は、アラームの発生順にリンクリストで繋がっています。</P>
<BLOCKQUOTE><IMG src="image_alarmStruct.gif" border="0"></BLOCKQUOTE>
<P>従って、そのアラーム構造体がまだリストに繋がっている(すなわち、まだアラームが発生していない)ものを使って別のアラームをセットしようとすると、リンク構造が崩れることになってしまいますのでこのようなことは行なわないでください。これを検出すると、ライブラリではビルドに関係なく
<A href="../debug/OS_Panic.html"><CODE>OS_Panic()</CODE></A> で停止します。</P>
<P>また、まだリストに繋がっている状態で(すなわち、まだアラームが発生していない状態で)、アラーム構造体に対し <CODE><A href="OS_CreateAlarm.html">OS_CreateAlarm()</A></CODE> で初期化を行なうこともリンク構造の破綻につながるため禁じられています。この場合、動作は不定となります。</P>
<HR>
<P><B>複数のアラームの扱い</B></P>
<P>アラームシステムが使用するタイマは 1 つですが、アプリケーションでは複数のアラームを同時に設定することが可能です。これは、内部でアラームを到達時刻の早いものから順にリストとして保持しており、リストの前から順に処理しているからです。つまり内部では一番到達時刻の早いアラームだけをハートウェアタイマを使ってアラーム処理を行ない、それが完了した後に次のアラームの処理行なうということを繰り返して複数のアラームを同時に設定出来るようにしています。</P>
<P>例えば、以下のように4つのアラームが設定されているとします。現在時刻(チック値)は70であり、最も到達時刻の早いアラームは　Alarm1
です。アラームシステムは、Alarm1 のためのタイマ割り込みを 30チックカウント後に発生するように設定します。</P>
<P><IMG src="alarmList1.gif" border="0"></P>
<P>時刻が 100 になると、Alarm1 のタイマ割り込みが掛かり、アラームハンドラが呼ばれます。</P>
<P><IMG src="alarmList2.gif" border="0"></P>
<P>その処理が終わった時刻を基準に次のアラームを設定します。下図の場合ですと、アラーム処理が終わった時刻が 105 で、次のアラームである Alarm2 は時刻 150 で割り込み発生させたいので、45 チックカウント後にタイマ割り込みが掛かるように設定します。</P>
<P><IMG src="alarmList3.gif" border="0"></P>
<P>以下、この繰り返しとなります。</P>
<HR>
<P><B>アラームハンドラ内でのキャンセル・設定</B></P>
<P>アラームハンドラ内で自らをキャンセルしたり再設定することについて説明します。</P>
<P>(1) 通常の一度のみのアラームがアラームハンドラで自らのアラームをキャンセルすることについて</P>
<BLOCKQUOTE>ハンドラが呼ばれている時点でアラームは発生していますので、自らのアラームキャンセルを行なう必要はありませんし、意味がありません。</BLOCKQUOTE>
<P>(2) 通常の一度のみのアラームがアラームハンドラで自らのアラームを使用して再設定することについて</P>
<BLOCKQUOTE>すでにそのアラームの OSAlarm 構造体オブジェクトはアラームリストから外れているので、再設定を行なうことは可能です。キャンセルは不要です。</BLOCKQUOTE>
<P>(3) 周期アラームがアラームハンドラで自らのアラームをキャンセルすることについて</P>
<BLOCKQUOTE>周期アラームの場合、アラームハンドラで自らのアラームをキャンセルすることができます。</BLOCKQUOTE>
<P>(4) 周期アラームがアラームハンドラで自らのアラームを使用して再設定することについて</P>
<BLOCKQUOTE>一度キャンセルした後に、そのアラームオブジェクトを用いて新たなアラームの設定を行なうことができます。</BLOCKQUOTE>
<HR>
<P><B>使用するハードウェアタイマ</B></P>
<P>アラームシステムはタイマ1を用います。このタイマチャンネルは、アプリケーションで使用することは出来ません。OS
のタイマ関数では、DEBUGビルドのときには <CODE><A href="../debug/SDK_ASSERT.html">SDK_ASSERT</A></CODE> によるチェックを行ないます。</P>
<H2>参照</H2>
<P><CODE><A href="../list_os.html#Alarm">OS関数一覧(アラーム)</A><BR>
</CODE></P>
<H2>履歴</H2>
<P>
2006/05/12 誤字の修正<br>
2005/03/08 用語統一 [割込み] → [割り込み]<br>
2004/11/05 初版</P>
</BODY>
</HTML>